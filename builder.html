<html>
  <head>
    
  </head>
  <body>
    <h1>Elements</h1>
    
    <div id="builderFrame" style="border:1px solid #000000;overflow-x:scroll;width:800px;height:600px;display:inline-block">
      <div id="builderCanvas" style="position: relative; width:4000px; height:600px"></div>
    </div>

    <div style="display:inline-block; border: 1px solid black;">
      <h2>Position</h2>
      <div>
      <label for="xpos">x:</label>
      <input id="xpos" type="number" step="10" oninput="xChange()">
      </div>
      <div>
      <label for="ypos">y:</label>
      <input id="ypos" type="number" step="10" oninput="yChange()">
      </div>
    </div>


    <div style="display:inline-block; border: 1px solid black;">
      <h2>Images</h2>
      <p>
        <a href="https://cdnb.artstation.com/p/assets/images/images/010/604/427/large/nick-rossi-gam322-nrossi-m11-lava.jpg">lava</a>
      </p>
      <form>
        <h4>Add image</h4>
        <div>
          <label for="image_url">Url</label>
          <input id="image_url" type="text" value="https://cdnb.artstation.com/p/assets/images/images/010/604/427/large/nick-rossi-gam322-nrossi-m11-lava.jpg">
          <button type="button" onclick="loadImage()">Add</button>
        </div>
      </form>
      <div id="images"></div>
    </div>

    <div style="display: block; border: 1px solid black; padding: 10px;">
      <button type="button" onclick="getOutput()">Get output</button>
      <div id="generated"></div>
    </div>

    <div>
      <h4>Layers</h4>
      <button type="button" onclick="loadLayers()">Load</button>
    </div>

    <script type="module">
      import LayerData from './layers/layer_data.js'
    </script>

    <script>
      function loadLayers() {
        console.log(LayerData.layer1)
      }

      function loadImage() {
        const imageUrlInput = document.getElementById('image_url')
        const imageUrl = imageUrlInput.value
        const imageList = document.getElementById('images')
        imageList.insertAdjacentHTML('afterbegin',
        `<div style="display:block;padding-top:5px;">
          <img class="list_img" src="`+imageUrl+`" width="100" height="100" draggable="true" onmousedown="addImageDrag()" style="border:1px solid black;">
          <div>
            <label>width:</label>
            <input oninput="widthChange()" class="image_width" type="number" step="10" value="100">  
          </div>
          <div>
            <label>height:</label>
            <input oninput="heightChange()" class="image_height" type="number" step="10" value="100">  
          </div>
        </div>`)
        imageUrlInput.value = ''
      }

      let selectedTile = null

      function xChange() {
        console.log('cx')
        let e = window.event;
        if (selectedTile) {
          selectedTile.style.left = e.target.value
        }
      }

      function yChange() {
        let e = window.event;
        if (selectedTile) {
          selectedTile.style.top = e.target.value
        }
      }

      function getOutput() {
        const builderCanvas = document.getElementById("builderCanvas")
        const parentRect = builderCanvas.getBoundingClientRect()
        let output = []
        for (element of builderCanvas.children) {
          const elementRect = element.getBoundingClientRect();
          const left = elementRect.left + builderCanvas.parentElement.scrollLeft - parentRect.left
          const top = elementRect.top + builderCanvas.parentElement.scrollTop - parentRect.top
          output.push({w:element.width,h:element.height,x:left,y:top,img:element.src})
        }
        const outputBox = document.getElementById("generated");
        outputBox.textContent = JSON.stringify(output)
      }

      function widthChange() {
        let e = window.event;
        e.target.parentNode.parentNode.getElementsByClassName('list_img')[0].width = e.target.value
      }

      function heightChange() {
        let e = window.event;
        e.target.parentNode.parentNode.getElementsByClassName('list_img')[0].height = e.target.value
      }

      let addingImage = null

      function addImageDrag() {
        let e = window.event;

        var rect = e.target.getBoundingClientRect(); 
        var posx = e.clientX - rect.left; 
        var posy = e.clientY - rect.top;

        addingImage = {
          src: e.target.src,
          width: e.target.width,
          height: e.target.height,
          offsetx: posx,
          offsety: posy,
        }

        if (e.target.classList.contains('img_tile')) {
          addingImage.moveElement = e.target
        }
      }

      function moveImageDrag() {
        console.log('moving')
      }

      const target = document.getElementById("builderCanvas");
      target.addEventListener("dragover", (event) => {
        event.preventDefault();
      });

      target.addEventListener('drop', (e) => {
        
        var rect = target.getBoundingClientRect(); 
        var posx = e.clientX - rect.left - addingImage.offsetx; 
        var posy = e.clientY - rect.top - addingImage.offsety;

        if (addingImage) {
          e.target.insertAdjacentHTML('beforeend', '<image class="img_tile" onmousedown="addImageDrag()" draggable="true" style="left:'+posx+'px;top:'+posy+'px;position:absolute" src="'+addingImage.src+'" width="'+addingImage.width+'" height="'+addingImage.height+'">')
          if (addingImage.moveElement) {
            addingImage.moveElement.remove()
          }
          selectedTile = e.target.lastChild
          const posInputx = document.getElementById("xpos");
          const posInputy = document.getElementById("ypos");
          posInputx.value = posx
          posInputy.value = posy
        }

        addingImage = null
      })
      
    </script>


  </body>
</html>